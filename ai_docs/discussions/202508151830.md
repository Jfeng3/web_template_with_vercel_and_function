# OpenAI Backend Migration and Vercel Function Fixes

**Date:** August 15, 2025  
**Session:** Complete OpenAI security refactor and production deployment fixes

## Problem Statement

The application was exposing OpenAI API keys in the frontend bundle via `VITE_OPENAI_API_KEY`, creating a significant security vulnerability. Additionally, Vercel functions were failing in production due to ES module compatibility issues.

## Issues Identified

### 1. Security Risk: Frontend API Key Exposure
- `VITE_OPENAI_API_KEY` was bundled into frontend code and publicly visible
- All OpenAI API calls were happening client-side
- API key could be extracted from browser developer tools

### 2. Production Deployment Failures
- Vercel functions returning 500 errors: `exports is not defined in ES module scope`
- Node.js version mismatch: attempting to use 22.x instead of required 20.x
- TypeScript compilation issues with CommonJS vs ES module formats

### 3. Development Environment Issues
- API calls failing in development: `/api/rephrase` returning 404
- No proper API routing setup for local development
- Missing proxy configuration between frontend and API functions

## Solutions Implemented

### ✅ 1. Complete OpenAI Backend Migration

**Moved to Backend Services:**
- `getCriticFeedback()` → `/api/critic` endpoint
- `transcribeAudio()` → `/api/transcribe` endpoint
- Existing: `getRephraseOptions()` → `/api/rephrase` 
- Existing: `getPhraseBank()` → `/api/phrase-bank`

**Added to `api/openai-service.ts`:**
```typescript
export async function getCriticFeedback(content: string): Promise<CriticResponse>
export async function transcribeAudio(audioBuffer: Buffer, filename: string): Promise<string>
```

**Created New Endpoints:**
- `api/critic.ts` - Writing feedback and suggestions
- `api/transcribe.ts` - Audio-to-text conversion with file upload handling

### ✅ 2. Frontend Security Cleanup

**Updated `src/api/openai.ts`:**
- Removed OpenAI client initialization
- Removed `VITE_OPENAI_API_KEY` dependency
- Updated all functions to call backend APIs
- Kept audio processing utilities client-side (`convertToWav`, `writeString`)

**Environment Variables:**
- ❌ Removed: `VITE_OPENAI_API_KEY` (frontend exposure)
- ✅ Kept: `OPENAI_API_KEY` (backend-only, secure)

### ✅ 3. Vercel Function Fixes

**ES Module Compatibility:**
```typescript
// Before (causing error)
export default async function handler(req, res) { ... }

// After (ES module compatible)
const handler = async (req, res) => { ... };
export default handler;
```

**Updated All Endpoints:**
- `api/rephrase.ts`
- `api/critic.ts` 
- `api/transcribe.ts`
- `api/phrase-bank.ts`

**Added `vercel.json` Configuration:**
```json
{
  "functions": {
    "api/**/*.ts": {
      "runtime": "@vercel/node@3.2.17"
    }
  },
  "nodeVersion": "20.x",
  "framework": "vite"
}
```

### ✅ 4. Development Environment Setup

**Added Vite Proxy Configuration:**
```typescript
// vite.config.ts
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:3000',
      changeOrigin: true,
      secure: false,
    },
  },
}
```

**Added Development Scripts:**
```json
{
  "scripts": {
    "dev": "vite",
    "dev:vercel": "vercel dev"
  }
}
```

## Development Workflow

### Primary: Full-Stack Development
```bash
vercel dev
# Frontend: localhost:3000/
# API: localhost:3000/api/*
# Everything in one server, no proxy needed
```

### Secondary: Split Development
```bash
# Terminal 1: API functions
vercel dev --listen 3000

# Terminal 2: Frontend with proxy
pnpm dev  # localhost:8080 → proxies /api to localhost:3000
```

## Production Testing

**Fixed Production Issues:**
- ✅ Resolved `exports is not defined` ES module error
- ✅ Fixed Node.js version compatibility (20.x)
- ✅ Enabled proper serverless function deployment

**Production URLs:**
- Frontend: `https://www.miniflow.app/`
- API: `https://www.miniflow.app/api/rephrase`

## Security Improvements

### Before:
```javascript
// Frontend (INSECURE)
const openai = new OpenAI({
  apiKey: import.meta.env.VITE_OPENAI_API_KEY, // 🚨 EXPOSED
  dangerouslyAllowBrowser: true
});
```

### After:
```javascript
// Frontend (SECURE)
const response = await fetch('/api/rephrase', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ content })
});

// Backend (SECURE)
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY // 🔒 SERVER-ONLY
});
```

## Files Modified

**New Files:**
- `api/critic.ts` - Critic feedback endpoint
- `api/transcribe.ts` - Audio transcription endpoint  
- `vercel.json` - Deployment configuration

**Updated Files:**
- `api/openai-service.ts` - Added critic and transcription functions
- `api/rephrase.ts` - Fixed ES module exports
- `api/phrase-bank.ts` - Fixed ES module exports
- `src/api/openai.ts` - Converted to backend API calls
- `vite.config.ts` - Added API proxy for development
- `package.json` - Added Vercel dev script
- `.env` - Removed VITE_OPENAI_API_KEY

## Results

✅ **Security:** OpenAI API keys no longer exposed in browser  
✅ **Production:** Vercel functions deploy and run successfully  
✅ **Development:** Flexible local development with proper API routing  
✅ **Functionality:** All features preserved (rephrase, critic, transcription)  
✅ **Performance:** Audio processing remains client-side where appropriate  

The application now follows security best practices while maintaining full functionality across development and production environments.