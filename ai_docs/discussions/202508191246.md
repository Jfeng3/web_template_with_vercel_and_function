# Fixing ESM Module Resolution in Vercel Functions

## Date: 2025-08-19 12:46

## Issue Overview
The application was experiencing module resolution errors when running Vercel functions locally:
```
Error: Cannot find module '/Users/jiefeng/WebstormProjects/miniflow/api/openai-service' imported from /Users/jiefeng/WebstormProjects/miniflow/api/rephrase.ts
```

This error occurred because the project uses ES modules (`"type": "module"` in package.json) but wasn't properly configured for Node.js ESM resolution rules.

## Root Cause Analysis
With `"type": "module"` in package.json, Node.js enforces strict ES module rules:
1. **Explicit file extensions required** - Relative imports must include `.js` extension
2. **Runtime vs compile-time** - Node.js sees compiled `.js` files, not source `.ts` files
3. **Module resolution mismatch** - TypeScript could resolve without extensions, but Node.js runtime could not

## Solution Implemented

### 1. Proper ESM Configuration in TypeScript
Updated `tsconfig.json` to use Node.js ESM resolution:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

### 2. Updated All API Imports
Changed all API function imports to use `.js` extensions:

**Before:**
```typescript
import { getRephraseOptions } from './openai-service';
```

**After:**
```typescript
import { getRephraseOptions } from './openai-service.js';
```

**Files Updated:**
- `api/rephrase.ts`
- `api/critic.ts` 
- `api/phrase-bank.ts`
- `api/transcribe.ts`

### 3. Maintained ES Module Structure
- Kept `"type": "module"` in package.json for modern ES modules
- Used `@vercel/node@3.2.17` runtime in vercel.json
- All API functions use `VercelRequest`/`VercelResponse` pattern

## Technical Details

### Why .js Extensions Work
With `"moduleResolution": "NodeNext"`, TypeScript understands:
- Source: `import from './openai-service.js'`
- Development: TypeScript finds `./openai-service.ts`
- Runtime: Node.js finds compiled `./openai-service.js`

### ESM vs CommonJS
This solution keeps modern ES modules while ensuring compatibility with Node.js runtime requirements.

## Testing Results
- ✅ TypeScript compilation: `pnpm build` passes
- ✅ Vercel functions: `pnpm dev:backend` starts successfully
- ✅ Module resolution: No import errors
- ✅ Frontend build: Vite compilation works correctly

## Development Workflow
```bash
# Option 1: Everything together on port 3000
pnpm dev:backend

# Option 2: Separate processes with proxy
# Terminal 1: Backend on port 3000
pnpm dev:backend
# Terminal 2: Frontend on port 8080 with proxy
pnpm dev
```

## Production Deployment
No separate build process needed - Vercel handles:
1. Frontend build via Vite
2. API function TypeScript compilation
3. Deployment with proper ESM resolution

```bash
# Deploy to production
pnpm deploy
```

## Key Learnings
1. **ES modules require explicit extensions** in Node.js runtime
2. **"NodeNext" module resolution** bridges TypeScript and Node.js ESM
3. **Vercel handles compilation** automatically in production
4. **Modern tooling** can maintain clean developer experience while meeting runtime requirements

This solution provides proper ESM support while maintaining compatibility with Vercel's serverless platform and TypeScript development workflow.